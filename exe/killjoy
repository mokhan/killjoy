#!/usr/bin/env ruby

require "bundler/setup"
$LOAD_PATH.unshift(File.expand_path("../lib", File.dirname(__FILE__)))
require "killjoy"
require "killjoy/server"

cpus = Facter.value('processors')['count'].to_i
shards = ENV.fetch("RMQ_SHARDS", 4).to_i

server = ServerEngine.create(Killjoy::Server, Killjoy::Worker) do
  {
    amqp_uri: ENV.fetch("RABBITMQ_URL", "amqp://guest:guest@localhost:5672"),
    daemonize: false,
    exchange: 'killjoy',
    exchange_type: 'x-modulus-hash',
    heartbeat: 2,
    pid_path: 'tmp/killjoy.pid',
    prefetch: cpus,
    queue_shards: shards,
    worker_type: 'process',
    workers: shards,
  }
end
server.run
