#!/usr/bin/env ruby

require "bundler/setup"
$LOAD_PATH.unshift(File.expand_path("../lib", File.dirname(__FILE__)))
require "killjoy"
require "sneakers/runner"
require "sneakers/metrics/statsd_metrics"
require "sneakers/metrics/logging_metrics"
require "logger"
require "statsd-ruby"

class BeforeFork
  def call
    puts "BEFORE FORK #{Process.pid}"
  rescue => error
    puts [error.message, error.backtrace].inspect
  end
end

class AfterFork
  def call
    puts "AFTER FORK #{Process.pid}"
    Killjoy::Startup.new(Spank::Container.new).run do |container|
      Spank::IOC.bind_to(container)
      Spank::IOC.resolve(:session).execute("select * from system.hints;")
    end
  rescue => error
    puts [error.message, error.backtrace].inspect
  end
end

Sneakers.configure({
  amqp: ENV.fetch("AMQP_URL", "amqp://guest:guest@localhost:5672"),
  exchange: 'shard.killjoy',
  exchange_type: 'x-modulus-hash',
  daemonize: false,
  log: STDOUT,
  metrics: Sneakers::Metrics::LoggingMetrics.new,
  #metrics: Sneakers::Metrics::StatsdMetrics.new(Statsd.new(ENV["STATSD_HOST"], 9125))
  env: ENV.fetch('ENV', 'development'),
  ack: true,
  durable: true,
  #timeout_job_after: 5,
  prefetch: 10,
  threads: 10,
  workers: 1,
  hooks: {
    after_fork: AfterFork.new,
    before_fork: BeforeFork.new,
  }
})
Sneakers.logger.level = Logger::INFO
Sneakers::Runner.new([ Killjoy::Consumer ]).run
